---
title: "Math 534 （new）"
author: "Pan"
format:
  gfm: default
---

```{r}
library(RMariaDB)
library(DBI)
library(tidyverse)
library(mdsr)

```

Q2
1 Point
Grading comment:
How many rows are available in the Measurements table of the Smith College Wideband Auditory Immittance database?


```{r}
con <- dbConnect(
  MariaDB(), host = "scidb.smith.edu",
  user = "waiuser", password = "smith_waiDB", 
  dbname = "wai"
)

n_rows <- dbGetQuery(con, "SELECT COUNT(*) AS n FROM Measurements")[1, 1]
n_rows 

```
The Measurements table contains 5052304 rows.

Q3
1 Point
Grading comment:
Identify what years of data are available in the flights table of the airlines database.
```{r}
con <- dbConnect_scidb("airlines")
tables <- dbGetQuery(con, "SHOW TABLES")
print(tables)
```

```{r}
flights_schema <- dbGetQuery(con, "DESCRIBE flights")
print(flights_schema)
```

```{r}
years <- dbGetQuery(con, "
  SELECT DISTINCT year
  FROM   flights
  ORDER  BY year
")$year
years 
```
The flights table contains data for the years 2013-2015.

Q4
5 Points
Grading comment:
Use the dbConnect_scidb function to connect to the airlines database to answer the following problem.
Q4.1
1 Point
Grading comment:
How many domestic flights flew into Dallas-Fort Worth (DFW) on May 14, 2015?
```{r}
head_sql <- dbGetQuery(con, "SELECT * FROM flights LIMIT 6")
print(head_sql)
```
```{r}
sql <- "
SELECT COUNT(*) AS n_flights
FROM flights
WHERE dest = 'DFW'
  AND year = 2015
  AND month = 5
  AND day = 14
"
ans <- dbGetQuery(con, sql)[1, "n_flights"]
ans
```
On May 14, 2015, 737 domestic flights arrived at Dallas-Fort Worth (DFW).

Q4.2
1 Point
Grading comment:
Of all the destinations from Chicago O’Hare (ORD), which were the most common in 2015?
```{r}
sql <- "
SELECT dest,
       COUNT(*) AS n_flights
FROM   flights
WHERE  origin = 'ORD'
  AND  year   = 2015
GROUP  BY dest
ORDER  BY n_flights DESC
LIMIT  10            
"
top_dest <- dbGetQuery(con, sql)
print(top_dest)
```

Q4.3
1 Point
Grading comment:
Which airport had the highest average arrival delay time in 2015?
```{r}
sql <- "
SELECT dest,
       AVG(arr_delay) AS avg_arr_delay
FROM   flights
WHERE  year = 2015
       AND arr_delay IS NOT NULL        
GROUP  BY dest
ORDER  BY avg_arr_delay DESC
LIMIT  1
"

ans <- dbGetQuery(con, sql)
ans
```
In 2015, STC had the highest average arrival delay at 21.6 minutes.

Q4.4
1 Point
Grading comment:
How many domestic flights came into or flew out of Bradley Airport (BDL) in 2015?
```{r}
sql <- "
SELECT SUM(cnt) AS total_flights
FROM (
    SELECT COUNT(*) AS cnt
    FROM flights
    WHERE year = 2015 AND dest = 'BDL'
    UNION ALL
    SELECT COUNT(*) AS cnt
    FROM flights
    WHERE year = 2015 AND origin = 'BDL'
) AS u
"

dbGetQuery(con, sql)[1, "total_flights"]
```
In 2015, 41025 domestic flights either departed from or arrived at Bradley Airport (BDL).

Q4.5
1 Point
Grading comment:
List the airline and flight number for all flights between LAX and JFK on September 26th, 2015.
```{r}
sql <- "
SELECT DISTINCT carrier, flight
FROM flights
WHERE year = 2015
  AND month = 9
  AND day = 26
  AND ((origin = 'LAX' AND dest = 'JFK') OR
       (origin = 'JFK' AND dest = 'LAX'))
ORDER BY carrier, flight
"

dbGetQuery(con, sql)
```

Q5
1 Point
Grading comment:
Wideband acoustic immittance (WAI) is an area of biomedical research that strives to develop WAI measurements as noninvasive auditory diagnostic tools. WAI measurements are reported in many related formats, including absorbance, admittance, impedance, power reflectance, and pressure reflectance. More information can be found about this public facing WAI database at http://www.science.smith.edu/wai-database/home/about.
```{r}
library(RMariaDB) 
db <- dbConnect(
  MariaDB(),    user = "waiuser",    password = "smith_waiDB",    host = "scidb.smith.edu",    dbname = "wai" )
```


a. How many female subjects are there in total across all studies?
```{r}
dbListTables(db)
```
```{r}
head_subjects <- dbGetQuery(db, "SELECT * FROM Subjects LIMIT 6")
print(head_subjects)
```


```{r}
n_female <- dbGetQuery(db,
  "SELECT COUNT(*) AS n_female
   FROM Subjects
   WHERE Sex = 'Female'")[1, "n_female"]

n_female
```
Across all studies, the WAI database contains 4727 female subjects. 

b. Find the average absorbance for participants for each study, ordered by highest to lowest value.
```{r}
head_measurements <- dbGetQuery(db, "SELECT * FROM Measurements LIMIT 6")
print(head_measurements)
```


```{r}
sql <- "
SELECT SUBSTRING_INDEX(s.Identifier,'_',1) AS studyID,
       AVG(m.Absorbance)                   AS avg_abs
FROM   Subjects s
JOIN   Measurements m ON s.SubjectNumber = m.SubjectNumber
WHERE  m.Absorbance IS NOT NULL
GROUP  BY studyID
ORDER  BY avg_abs DESC
"
dbGetQuery(db, sql)
```
c. Write a query to count all the measurements with a calculated absorbance of less than 0.
```{r}
n_low_abs <- dbGetQuery(db,
  "SELECT COUNT(*) AS n_low_abs
   FROM Measurements
   WHERE Absorbance < 0")[1, "n_low_abs"]
n_low_abs
```
A total of 28694 measurements in the database have a calculated absorbance less than zero.

Q6
1 Point
Grading comment:
The following open-ended question may require more than one query and a thoughtful response. Based on data from 2013 only, and assuming that transportation to the airport is not an issue, would you rather fly out of JFK, LaGuardia (LGA), or Newark (EWR)? Why or why not? Use the dbConnect_scidb function to connect to the airlines database.
```{r}
sql <- "
SELECT origin,
       COUNT(*) AS n_flights,
       AVG(arr_delay) AS avg_arr_delay,
       SUM(arr_delay <= 15) / COUNT(*) AS pct_ontime
FROM flights
WHERE year = 2013
  AND origin IN ('JFK','LGA','EWR')
  AND arr_delay IS NOT NULL
GROUP BY origin
ORDER BY pct_ontime DESC
"

dbGetQuery(con, sql)
```
Based on 2013 arrival statistics, LaGuardia (LGA) offers the best on-time performance (78.4 %) and the shortest average arrival delay (5.6 min).
Therefore, I would choose to fly on LGA in 2013, assuming ground transportation is equally convenient.

